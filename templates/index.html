<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Text Detection System</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for better table rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="container">

<header>
    <h1>AI vs Human Text Detector</h1>
    <p class="subtitle">Upload a PDF or DOCX file to analyze AI vs Human text. You can skip unwanted paragraphs.</p>
</header>

<section class="upload-box">
    <form method="POST" enctype="multipart/form-data" class="inline-form">
        <input type="file" name="file" accept=".pdf,.docx" required>
        <button type="submit">Analyze Text</button>
    </form>
    <form method="GET" action="/" class="inline-form">
        <button type="submit" class="clear-btn">Clear</button>
    </form>
</section>

{% if ai_score is not none %}
<form method="POST" class="skip-form">
    <input type="hidden" name="file" value="{{ request.files['file'].filename if request.files.get('file') else '' }}">

    <!-- Overall Scores -->
    <section class="result-box" id="pdf-content">
        <h2>Overall Detection Result</h2>
        <div class="score-cards">
            <div class="card ai-card">
                <h3>AI Generated</h3>
                <p>{{ ai_score }}%</p>
            </div>
            <div class="card human-card">
                <h3>Human Written</h3>
                <p>{{ human_score }}%</p>
            </div>
        </div>

        <!-- Paragraph-level Analysis -->
        <section class="table-box">
            <h2>Paragraph-level Analysis</h2>
            <table>
                <thead>
                    <tr>
                        <th>Skip?</th>
                        <th>Page</th>
                        <th>Paragraph</th>
                        <th>AI %</th>
                        <th>Human %</th>
                        <th>Classification</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in details %}
                    <tr class="{{ 'ai' if row.label=='AI-generated' else 'human' }}">
                        <td>{{ row.page }}-{{ row.index }}</td>
                        <td>{{ row.page }}</td>
                        <td class="sentence">{{ row.text }}</td>
                        <td>{{ row.ai }}</td>
                        <td>{{ row.human }}</td>
                        <td><b>{{ row.label }}</b></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </section>
    </section>

    <!-- Buttons -->
    <div class="form-buttons">
        <button type="submit" style="margin-top:10px;">Recalculate Without Skipped Paragraphs</button>
        <button type="button" class="download-btn" onclick="downloadPDF()" style="margin-left:20px;">Download PDF Report</button>
    </div>
</form>

<script>
function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    const content = document.getElementById("pdf-content");

    html2canvas(content, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth() - 40;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        let position = 20;

        if (pdfHeight < doc.internal.pageSize.getHeight() - 40) {
            doc.addImage(imgData, 'PNG', 20, position, pdfWidth, pdfHeight);
        } else {
            // Split long content into multiple pages
            let pageHeight = doc.internal.pageSize.getHeight() - 40;
            let totalPages = Math.ceil(pdfHeight / pageHeight);
            for (let i = 0; i < totalPages; i++) {
                const srcY = i * pageHeight * (imgProps.height / pdfHeight);
                const sHeight = Math.min(pageHeight * (imgProps.height / pdfHeight), imgProps.height - srcY);
                const canvasPage = document.createElement('canvas');
                canvasPage.width = canvas.width;
                canvasPage.height = sHeight;
                const ctx = canvasPage.getContext('2d');
                ctx.drawImage(canvas, 0, -srcY);
                const imgPage = canvasPage.toDataURL('image/png');
                if (i > 0) doc.addPage();
                doc.addImage(imgPage, 'PNG', 20, 20, pdfWidth, pageHeight);
            }
        }

        doc.save("AI_Text_Report.pdf");
    });
}
</script>
{% endif %}

<footer>
    <p>Perplexity-based AI Text Detection â€¢ Research Prototype</p>
</footer>

</div>
</body>
</html>
